<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إتمام الشراء | الشرقاوي</title>
    <link rel="icon" type="image/png" href="images/logo.png">
    <link rel="shortcut icon" type="image/png" href="images/logo.png">
    <link rel="apple-touch-icon" href="images/logo.png">
    <meta name="theme-color" content="#486b65">
    <!-- Open Graph / Meta -->
    <meta property="og:title" content="إتمام الشراء | الشرقاوي">
    <meta property="og:image" content="images/banner.jpg">
    <meta property="twitter:image" content="images/banner.jpg">
    <meta property="twitter:card" content="summary_large_image">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Cairo:wght@400;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/toast.css">

    <!-- Meta Pixel Code -->
    <script src="js/pixel.js"></script>
    <noscript>
        <img height="1" width="1" style="display:none"
            src="https://www.facebook.com/tr?id=2734165686928707&ev=PageView&noscript=1" />
    </noscript>
    <!-- End Meta Pixel Code -->
    <style>
        .checkout-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            margin-top: 2rem;
            position: relative;
        }

        /* Essential Fix: Correct stacking context when dropdown is open */
        .reveal.lifting {
            z-index: 9999 !important;
            position: relative !important;
        }

        @media (max-width: 768px) {
            .checkout-layout {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.8rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .payment-option {
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-option:hover,
        .payment-option.selected {
            border-color: var(--color-primary);
            background: #f0f5f4;
        }

        .stripe-mock {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            display: none;
        }

        /* Custom Dropdown Styling (New) */
        .custom-dropdown {
            position: relative;
            width: 100%;
            font-family: 'Cairo', sans-serif;
            z-index: 100;
            /* Base z-index */
        }

        .custom-dropdown.active {
            z-index: 9999999 !important;
            isolation: isolate;
            background: white !important;
        }

        .dropdown-trigger {
            z-index: 10;
            position: relative;
        }

        .dropdown-trigger {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--color-primary);
            border-radius: 12px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: 700;
            color: #2c3e50;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(72, 107, 101, 0.08);
        }

        .dropdown-trigger:hover {
            background: #f0f5f4;
        }

        .dropdown-trigger i {
            font-size: 0.9rem;
            color: var(--color-primary);
            transition: transform 0.3s;
        }

        .custom-dropdown.active .dropdown-trigger i {
            transform: rotate(180deg);
        }

        @keyframes dropdownSlideIn {
            from {
                transform: translateY(-10px);
            }

            to {
                transform: translateY(0);
            }
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: #ffffff !important;
            background-color: #ffffff !important;
            border: 2px solid var(--color-primary) !important;
            border-top: none !important;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            z-index: 10001 !important;
            display: none;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2) !important;
            transform-origin: top;
            opacity: 1 !important;
            backdrop-filter: none !important;
            visibility: visible !important;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .custom-dropdown.active .dropdown-menu {
            display: block !important;
            background: #ffffff !important;
            background-color: #ffffff !important;
            opacity: 1 !important;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15) !important;
        }

        /* Clear any blocking overlays or blurs */
        #mobile-overlay {
            display: none !important;
        }

        body.dropdown-open main {
            filter: none !important;
            filter: blur(0) !important;
            opacity: 1 !important;
        }

        body.dropdown-open {
            overflow: visible !important;
        }


        .dropdown-search {
            padding: 12px;
            background-color: #ffffff !important;
            background: #ffffff !important;
            border-bottom: 2px solid #f1f5f9;
            position: sticky;
            top: 0;
            z-index: 101;
            opacity: 1 !important;
        }

        .dropdown-search input {
            width: 100% !important;
            padding: 12px 15px !important;
            border: 2px solid var(--color-primary) !important;
            border-radius: 10px !important;
            font-family: inherit;
            margin-bottom: 0 !important;
            font-size: 1rem !important;
            background-color: #ffffff !important;
            background: #ffffff !important;
            color: #333 !important;
            opacity: 1 !important;
            box-shadow: none !important;
        }

        .dropdown-search input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(72, 107, 101, 0.15);
            outline: none;
        }

        .dropdown-options {
            max-height: 280px;
            overflow-y: auto;
            background-color: #ffffff !important;
            background: #ffffff !important;
            opacity: 1 !important;
        }

        .dropdown-option {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f1f5f9;
            background-color: #ffffff !important;
            background: #ffffff !important;
            opacity: 1 !important;
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: #f0f7ff;
            padding-right: 25px;
        }

        .dropdown-option .city-name {
            font-weight: 700;
            color: #1e293b;
            font-size: 1rem;
        }

        .dropdown-option .shipping-badge {
            background: #f0f5f4;
            color: var(--color-primary);
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            border: 1px solid #d1dbd9;
        }

        .dropdown-option:hover .shipping-badge {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .dropdown-no-results {
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* Form styling fix */
        #province {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            width: 0;
            height: 0;
        }

        @media (max-width: 768px) {

            /* Revert Mobile Overhaul to standard clean dropdown like user image */
            .custom-dropdown.active .dropdown-menu {
                position: absolute;
                top: calc(100% + 5px);
                left: 0;
                width: 100%;
                height: auto;
                max-height: 400px;
                border: 2px solid var(--color-primary) !important;
                border-radius: 12px;
                z-index: 10000 !important;
                animation: dropdownFadeIn 0.2s ease-out;
            }

            .dropdown-menu .mobile-header {
                display: none !important;
            }

            .dropdown-options {
                max-height: 250px !important;
                overflow-y: auto;
            }
        }
    </style>
    <!-- SMTP.js Library for SendPulse -->
    <script src="https://smtpjs.com/v3/smtp.js"></script>
    <!-- Web3Forms Email Service (No Business Email Required!) -->
</head>

<body class="rtl">
    <header>
        <div class="container">
            <nav style="justify-content: center;">
                <a href="index.html" class="logo">
                    <img src="images/logo.png" alt="الشرقاوي" style="height: 70px; width: auto;">
                </a>
            </nav>
        </div>
    </header>

    <main class="container" style="padding: 4rem 15px;">
        <div class="checkout-layout">
            <div class="reveal">
                <h2 data-i18n="shipping_details">بيانات الشحن</h2>
                <form id="checkout-form" style="margin-top: 2rem;">
                    <div class="form-group">
                        <label data-i18n="full_name">الاسم الكامل</label>
                        <input type="text" id="name" required placeholder="الاسم ثلاثي"
                            style="width: 100%; padding: 14px 18px; border: 1.5px solid #e1e8ed; border-radius: 10px; font-family: 'Cairo', sans-serif; font-size: 1rem;">
                    </div>
                    <div class="form-group">
                        <label data-i18n="phone">رقم الهاتف</label>
                        <input type="tel" id="phone" required placeholder="01xxxxxxxxx"
                            style="width: 100%; padding: 14px 18px; border: 1.5px solid #e1e8ed; border-radius: 10px; font-family: 'Cairo', sans-serif; font-size: 1rem;">
                    </div>
                    <div class="form-group">
                        <label data-i18n="address">العنوان</label>
                        <textarea id="address" rows="3" required placeholder="برجاء ادخال العنوان بالكامل"
                            style="width: 100%; padding: 14px 18px; border: 1.5px solid #e1e8ed; border-radius: 10px; font-family: 'Cairo', sans-serif; font-size: 1rem;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>المحافظة / المدينة</label>
                        <div class="custom-dropdown" id="province-dropdown">
                            <div class="dropdown-trigger" onclick="toggleProvinceDropdown(event)">
                                <span id="selected-province-text">اختر المحافظة...</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="dropdown-menu">
                                <div class="mobile-header hide-desktop" style="display: none;">
                                    <i class="fas fa-times close-btn" onclick="closeProvinceDropdown()"></i>
                                    <h3>اختر المحافظة</h3>
                                    <div style="width: 20px;"></div>
                                </div>
                                <!-- Search Box - Permanently Visible -->
                                <div class="dropdown-search" id="province-search-box">
                                    <input type="text" id="province-search" placeholder="ابحث عن محافظتك..."
                                        oninput="filterProvinces()" autocomplete="off">
                                </div>
                                <div class="dropdown-options" id="province-options">
                                    <!-- Items populated via JS -->
                                </div>
                            </div>
                        </div>
                        <input type="text" id="province" required
                            style="position: absolute; opacity: 0; pointer-events: none; height: 1px;">
                    </div>

                    <!-- Inspection Option -->
                    <div
                        style="margin-top: 1rem; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee; display: flex; align-items: center; gap: 12px; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                        <div style="position: relative; display: flex; align-items: center;">
                            <input type="checkbox" id="allow-inspection" onchange="calculateTotalWithShipping()"
                                style="width: 22px; height: 22px; cursor: pointer; accent-color: var(--color-primary);">
                        </div>
                        <div style="flex: 1;">
                            <label for="allow-inspection"
                                style="cursor: pointer; display: block; font-weight: 700; color: #2c3e50; margin-bottom: 2px;">
                                المعاينة عند الاستلام
                                <span
                                    style="font-size: 0.8rem; background: #eee; color: #555; padding: 2px 8px; border-radius: 4px; margin-right: 5px;">اختياري</span>
                            </label>
                            <div style="font-size: 0.85rem; color: #7f8c8d;">يضيف <span
                                    style="color: #e74c3c; font-weight: 700;">8 ج.م</span> لسعر الشحن</div>
                        </div>
                    </div>
                </form>


            </div>

            <div class="reveal delay-100">
                <h2 data-i18n="payment_method">طريقة الدفع</h2>
                <div style="margin-top: 2rem;">
                    <div class="payment-option selected" onclick="selectPayment('cod', this)">
                        <i class="fas fa-money-bill-wave"></i> <span data-i18n="cod">الدفع عند الاستلام</span>
                    </div>
                    <div class="payment-option" onclick="selectPayment('vodafone', this)">
                        <i class="fas fa-mobile-alt"></i> <span data-i18n="vodafone">فودافون كاش</span>
                    </div>
                    <div class="payment-option" onclick="selectPayment('instapay', this)">
                        <i class="fas fa-university"></i> <span data-i18n="instapay">انستا باي (InstaPay)</span>
                    </div>


                    <!-- Instructions / Details -->
                    <div id="payment-details-vodafone" class="stripe-mock"
                        style="background: #fff5f5; border-color: #ffcccc;">
                        <p style="color: #d63031; font-weight: 700; margin-bottom: 5px;">تحويل لمبلغ الإجمالي على رقم:
                        </p>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <p style="font-size: 1.2rem; font-weight: 800; color: #b71540; margin: 0;">01147464668</p>
                            <button type="button" onclick="copyToClipboard('01147464668', this)"
                                style="padding: 4px 10px; font-size: 0.8rem; cursor: pointer; border: 1px solid #b71540; color: #b71540; background: white; border-radius: 4px; transition: all 0.2s;">
                                <i class="fas fa-copy"></i> نسخ
                            </button>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="file-upload-label" id="vodafone-proof-label" for="vodafone-proof"
                                style="font-size: 0.85rem; color: #d63031; display: block; padding: 15px; border: 2px dashed #ffcccc; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s; background: #fff;">
                                <i class="fas fa-camera"
                                    style="font-size: 1.5rem; display: block; margin-bottom: 8px;"></i>
                                <span style="font-weight: 700;">اضغط هنا لرفع صورة التحويل (إجباري)</span>
                            </label>
                            <input type="file" id="vodafone-proof" accept="image/*" onchange="handleProofUpload(this)"
                                style="display: none;">
                        </div>
                    </div>

                    <div id="payment-details-instapay" class="stripe-mock"
                        style="background: #f0fff4; border-color: #c6f6d5;">
                        <p style="color: #27ae60; font-weight: 700; margin-bottom: 5px;">التحويل عبر انستا باي على
                            الرقم:</p>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <p style="font-size: 1.2rem; font-weight: 800; color: #218c53; margin: 0;">01147464668</p>
                            <button type="button" onclick="copyToClipboard('01147464668', this)"
                                style="padding: 4px 10px; font-size: 0.8rem; cursor: pointer; border: 1px solid #218c53; color: #218c53; background: white; border-radius: 4px; transition: all 0.2s;">
                                <i class="fas fa-copy"></i> نسخ
                            </button>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="file-upload-label" id="instapay-proof-label" for="instapay-proof"
                                style="font-size: 0.85rem; color: #27ae60; display: block; padding: 15px; border: 2px dashed #c6f6d5; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s; background: #fff;">
                                <i class="fas fa-university"
                                    style="font-size: 1.5rem; display: block; margin-bottom: 8px;"></i>
                                <span style="font-weight: 700;">اضغط هنا لرفع صورة التحويل (إجباري)</span>
                            </label>
                            <input type="file" id="instapay-proof" accept="image/*" onchange="handleProofUpload(this)"
                                style="display: none;">
                        </div>
                    </div>


                </div>

                <div
                    style="margin-top: 2rem; background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #eee;">
                    <label style="display: block; margin-bottom: 0.8rem; font-weight: 700; color: #2c3e50;">هل لديك
                        كود
                        خصم؟</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="coupon-code" placeholder="أدخل الكود هنا..."
                            style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Cairo', sans-serif;">
                        <button type="button" onclick="applyCoupon()" class="btn btn-secondary"
                            style="padding: 0 20px; border-radius: 8px; background: #34495e; color: white;">تطبيق</button>
                    </div>
                    <div id="coupon-message" style="margin-top: 10px; font-size: 0.9rem; font-weight: 600;"></div>
                </div>

                <div style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 2rem;">

                    <div style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 2rem;">
                        <div
                            style="display: flex; justify-content: space-between; font-size: 1.1rem; color: #666; margin-bottom: 0.8rem;">
                            <span id="subtotal-label">إجمالي المنتجات:</span>
                            <span id="subtotal">0 ج.م</span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; font-size: 1.1rem; color: #666; margin-bottom: 0.8rem;">
                            <span>مصاريف الشحن:</span>
                            <span id="shipping-cost">0 ج.م</span>
                        </div>
                        <div id="discount-row"
                            style="display: none; justify-content: space-between; font-size: 1.1rem; color: #e74c3c; margin-bottom: 1.2rem; font-weight: 700;">
                            <span>خصم الكوبون:</span>
                            <span id="discount-amount">-0 ج.م</span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; font-size: 1.8rem; font-weight: 900; border-top: 2px solid var(--color-primary); padding-top: 15px; color: #2c3e50;">
                            <span data-i18n="total">الإجمالي النهائى:</span>
                            <span id="checkout-total">0 ج.م</span>
                        </div>
                        <button type="button" onclick="submitOrder()" class="btn btn-primary" id="btn-place-order"
                            style="width: 100%; margin-top: 1.5rem; height: 60px; font-size: 1.3rem; font-weight: 900; border-radius: 12px; box-shadow: 0 4px 15px rgba(72, 107, 101, 0.3);"
                            data-i18n="place_order">تأكيد
                            طلب الشراء</button>

                    </div>
                </div>
            </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div>
                    <h3>الشرقاوي</h3>
                    <p style="margin-top: 20px; color: #888;" data-i18n="premium_exp">تجربة تسوق فاخرة.</p>
                </div>
                <div>
                    <h4 data-i18n="links">روابط</h4>
                    <ul style="list-style: none; margin-top: 20px; line-height: 2;">
                        <li><a href="index.html" data-i18n="home">الرئيسية</a></li>
                        <li><a href="products.html" data-i18n="shop">المتجر</a></li>
                        <li><a href="cart.html" data-i18n="cart_title">السلة</a></li>
                    </ul>
                </div>
                <div>
                    <h4 data-i18n="policies">السياسات</h4>
                    <ul style="list-style: none; margin-top: 20px; line-height: 2;">
                        <li><a href="policies.html#terms">الشروط والأحكام</a></li>
                        <li><a href="policies.html#shipping">سياسة الشحن</a></li>
                        <li><a href="policies.html#refund">سياسة الاسترجاع</a></li>
                        <li><a href="policies.html#privacy">سياسة الخصوصية</a></li>
                    </ul>
                </div>
                <div>
                    <h4 data-i18n="contact">تواصل معنا</h4>
                    <p style="margin-top: 20px; color: #888;">ibrahimelsharqawi5@gmail.com</p>
                    <p style="color: #888;">+20 115 402 5770</p>
                </div>
            </div>
            <div
                style="margin-top: 4rem; border-top: 1px solid #333; padding-top: 2rem; text-align: center; color: #666;">
                &copy; 2026 الشرقاوي. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="js/firebase-config.js"></script>

    <script src="js/email-service.js"></script>
    <script src="js/data_v2.js?v=fix001"></script>
    <script src="js/translations.js"></script>
    <script src="js/bosta-integration.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Check if customer is logged in
        if (!db.isCustomerLoggedIn()) {
            // Wait for main.js to load to use showToast if possible, or use simple redirect
            // Since this runs immediately, showToast might not be ready if main.js is at bottom.
            // However main.js is at bottom. But this script is also at bottom.
            // We can rely on main.js being loaded before this inline script if it is placed above.
            // It is placed above (line 217).

            // showToast might not persist across redirect, so we use URL param or just redirect.
            // But user wants "interface ... from store".
            // Since we redirect immediately, toast won't be seen.
            // Better to redirect to login with a message param?
            // Existing logic handles redirect.
            window.location.href = 'login.html?redirect=checkout.html';
        }

        let selectedPayment = 'cod';
        let appliedCoupon = null;
        let discount = 0;

        // Mode handling: buynow vs cart
        const checkoutMode = localStorage.getItem('checkout_mode') || 'cart';
        let cart = [];
        if (checkoutMode === 'buynow') {
            const item = JSON.parse(localStorage.getItem('buynow_item'));
            if (item) cart = [item];
            else cart = db.getCart();
        } else {
            cart = db.getCart();
        }

        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        if (cart.length === 0) {
            window.location.href = 'cart.html';
        }

        // Initialize Page
        document.addEventListener('DOMContentLoaded', () => {
            // Update labels based on item count
            const subtotalLabel = document.getElementById('subtotal-label');
            if (subtotalLabel) {
                subtotalLabel.innerText = cart.length === 1 ? 'سعر المنتج:' : 'إجمالي المنتجات:';
            }

            initProvinces();
            calculateTotalWithShipping();
            prefillText();

            // Track InitiateCheckout Event
            if (typeof trackEvent === 'function') {
                trackEvent('InitiateCheckout', {
                    value: subtotal,
                    currency: 'EGP',
                    num_items: cart.length
                });
            }
        });

        function initProvinces() {
            const optionsContainer = document.getElementById('province-options');
            const rates = db.getShippingRates();

            optionsContainer.innerHTML = rates.map(r => `
                <div class="dropdown-option" onclick="selectProvince('${r.city}', ${r.rate})">
                    <span class="city-name">${r.city}</span>
                    <span class="shipping-badge">${r.rate} ج.م</span>
                </div>
            `).join('');
        }


        function toggleProvinceDropdown(e) {
            if (e) e.stopPropagation();
            const dropdown = document.getElementById('province-dropdown');
            const parentReveal = dropdown.closest('.reveal');
            const isActive = dropdown.classList.toggle('active');

            if (isActive) {
                if (parentReveal) parentReveal.classList.add('lifting');

                // Focus on search input when dropdown opens
                setTimeout(() => {
                    const searchInput = document.getElementById('province-search');
                    if (searchInput) searchInput.focus();
                }, 100);
            } else {
                if (parentReveal) parentReveal.classList.remove('lifting');
            }
        }

        function closeProvinceDropdown() {
            const dropdown = document.getElementById('province-dropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
                const parentReveal = dropdown.closest('.reveal');
                if (parentReveal) parentReveal.classList.remove('lifting');
            }
            document.body.style.overflow = '';
            document.body.classList.remove('dropdown-open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('province-dropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                if (!dropdown.contains(e.target) && !e.target.closest('.dropdown-trigger')) {
                    closeProvinceDropdown();
                }
            }
        });

        function filterProvinces() {
            const query = document.getElementById('province-search').value.toLowerCase();
            const options = document.querySelectorAll('.dropdown-option');
            let hasResults = false;

            options.forEach(opt => {
                const city = opt.querySelector('.city-name').innerText.toLowerCase();
                if (city.includes(query)) {
                    opt.style.display = 'flex';
                    hasResults = true;
                } else {
                    opt.style.display = 'none';
                }
            });

            // Handle no results
            const noRes = document.querySelector('.dropdown-no-results');
            if (!hasResults) {
                if (!noRes) {
                    const div = document.createElement('div');
                    div.className = 'dropdown-no-results';
                    div.innerText = 'عذراً، لم نجد هذه المحافظة';
                    document.getElementById('province-options').appendChild(div);
                }
            } else if (noRes) {
                noRes.remove();
            }
        }



        function selectProvince(city, rate) {
            const hiddenInput = document.getElementById('province');
            hiddenInput.value = city;
            // No longer setting dataset.rate here as calculateTotalWithShipping handles it based on total weight

            closeProvinceDropdown();
            calculateTotalWithShipping();

            // Trigger change for abandoned cart
            hiddenInput.dispatchEvent(new Event('change'));
        }


        function applyCoupon() {
            const code = document.getElementById('coupon-code').value.trim();
            const messageEl = document.getElementById('coupon-message');

            if (!code) {
                messageEl.innerText = 'يرجى إدخال كود الخصم أولاً';
                messageEl.style.color = '#e74c3c';
                return;
            }

            const res = db.validateCoupon(code);
            if (res.valid) {
                appliedCoupon = res.coupon;
                const discMsg = appliedCoupon.type === 'percentage' ? appliedCoupon.discount + '%' : appliedCoupon.discount + ' ج.م';
                messageEl.innerText = `تم تطبيق الخصم: ${discMsg}`;
                messageEl.style.color = '#27ae60';
                calculateTotalWithShipping();
            } else {
                appliedCoupon = null;
                messageEl.innerText = res.message;
                messageEl.style.color = '#e74c3c';
                calculateTotalWithShipping();
            }
        }

        function calculateTotalWithShipping() {
            const hiddenInput = document.getElementById('province');
            const cityName = hiddenInput.value;
            let baseShipping = 0;
            let sizeSurcharge = 0;
            let inspectionFee = (document.getElementById('allow-inspection') && document.getElementById('allow-inspection').checked) ? 8 : 0;
            let codCommission = 0;

            if (cityName) {
                const rates = db.getShippingRates();
                const areaRate = rates.find(r => r.city.trim() === cityName.trim()) || rates.find(r => r.city === 'المحافظات الأخرى');

                if (areaRate) {
                    baseShipping = areaRate.rate || 0;
                }

                if (typeof BostaIntegration !== 'undefined') {
                    const pkg = BostaIntegration.getPackageDetails(cart);
                    sizeSurcharge = pkg.totalExtra || 0;
                    hiddenInput.dataset.packageDetails = JSON.stringify(pkg);
                    console.log('📦 Bosta Package:', pkg.label, 'Extra:', pkg.totalExtra);
                } else {
                    const totalQty = (cart || []).length;
                    if (totalQty >= 4) {
                        sizeSurcharge = 10;
                    } else if (totalQty > 1) {
                        sizeSurcharge = 5;
                    }
                }

                const currentTotal = subtotal + baseShipping + sizeSurcharge + inspectionFee;
                if (selectedPayment === 'cod' && currentTotal > 2000) {
                    codCommission = Math.ceil((currentTotal - 2000) * 0.01);
                } else {
                    codCommission = 0;
                }
            }

            const totalShippingCost = baseShipping + sizeSurcharge + inspectionFee + codCommission;
            hiddenInput.dataset.calculatedShipping = totalShippingCost;

            if (cityName) {
                document.getElementById('selected-province-text').innerHTML = `${cityName} <span style="color: #486b65; font-size: 0.9rem; margin-right: 10px;">(+${totalShippingCost} ج.م)</span>`;
            }

            // 1. Get Global Discount from Special Offers
            const offers = db.getSpecialOffers();
            const isGlobalEnabled = offers && offers.globalDiscountEnabled;
            const globalDiscountPercent = (isGlobalEnabled && offers.globalDiscountPercentage) ?
                parseFloat(offers.globalDiscountPercentage) : 0;
            const globalDiscountAmount = (subtotal * globalDiscountPercent) / 100;

            // 2. Base Total after global discount
            const subtotalAfterGlobal = subtotal - globalDiscountAmount;

            // 3. Apply Coupon Discount (on top of global discount)
            discount = 0;
            if (appliedCoupon) {
                if (appliedCoupon.type === 'percentage') {
                    discount = (subtotalAfterGlobal * appliedCoupon.discount) / 100;
                } else {
                    discount = appliedCoupon.discount;
                }
            }

            const total = subtotalAfterGlobal + totalShippingCost - discount;

            document.getElementById('subtotal').innerText = subtotal + ' ج.م';
            document.getElementById('shipping-cost').innerText = totalShippingCost + ' ج.م';

            const discountRow = document.getElementById('discount-row');
            const finalDiscount = globalDiscountAmount + discount;

            if (finalDiscount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('discount-amount').innerText = `-${finalDiscount} ج.م`;
            } else {
                discountRow.style.display = 'none';
            }

            document.getElementById('checkout-total').innerText = Math.max(0, total) + ' ج.م';

            // Free Shipping Offer Check
            if (offers.freeShippingThreshold && subtotal >= offers.freeShippingThreshold) {
                document.getElementById('shipping-cost').innerText = '0 ج.م (عرض)';
                document.getElementById('checkout-total').innerText = Math.max(0, subtotalAfterGlobal - discount) + ' ج.م';
            }
        }

        function prefillText() {
            const customer = db.getCustomer();
            if (customer) {
                if (document.getElementById('name')) document.getElementById('name').value = customer.name;
            }
        }

        function selectPayment(method, el) {
            selectedPayment = method;
            document.querySelectorAll('.payment-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');

            // Hide all details
            document.getElementById('payment-details-vodafone').style.display = 'none';
            document.getElementById('payment-details-instapay').style.display = 'none';

            // Show relevant details
            if (method === 'vodafone') document.getElementById('payment-details-vodafone').style.display = 'block';
            if (method === 'instapay') document.getElementById('payment-details-instapay').style.display = 'block';

            // Recalculate total because COD commission depends on payment method
            calculateTotalWithShipping();
        }

        let processedPaymentProof = null;
        async function handleProofUpload(input) {
            const file = input.files[0];
            if (!file) {
                processedPaymentProof = null;
                return;
            }

            const labelId = input.id + '-label';
            const label = document.getElementById(labelId);
            const originalContent = label.innerHTML;

            try {
                label.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري معالجة الصورة...';
                label.style.opacity = '0.7';

                processedPaymentProof = await resizeImage(file, 600, 0.5);

                label.innerHTML = '<i class="fas fa-check-circle"></i> تم تجهيز الصورة بنجاح';
                label.style.background = '#e8f5e9';
                label.style.borderColor = '#2ecc71';
                label.style.color = '#27ae60';
                label.style.opacity = '1';
            } catch (e) {
                console.error(e);
                label.innerHTML = '<i class="fas fa-exclamation-triangle"></i> حدث خطأ، حاول مرة أخرى';
                label.style.background = '#fff5f5';
                label.style.borderColor = '#e74c3c';
                label.style.color = '#d63031';
            }
        }

        // Abandoned Cart Trigger
        document.querySelectorAll('#checkout-form input, #checkout-form textarea, #checkout-form select').forEach(el => {
            el.addEventListener('change', () => {
                const customerInfo = {
                    name: document.getElementById('name').value,
                    address: document.getElementById('address').value,
                    province: document.getElementById('province').value,
                    phone: document.getElementById('phone').value
                };
                db.saveAbandonedCart(cart, customerInfo);
            });
        });

        async function resizeImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.height > 0 ? canvas.getContext('2d') : null;
                        if (!ctx) return reject('Canvas context error');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function submitOrder() {
            // Manual Validation for better UX (especially for hidden inputs)
            const provinceValue = document.getElementById('province').value;
            if (!provinceValue) {
                showToast('يرجى اختيار المحافظة من القائمة', 'error');
                return;
            }

            const form = document.getElementById('checkout-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const btn = document.getElementById('btn-place-order');
            const originalText = btn.innerText;

            // 1. INSTANT FEEDBACK: "Processing..."
            // We revert to standard clear feedback: Spinner first, then Success checkmark.
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التنفيذ...';
            btn.style.background = '#3498db';
            btn.style.boxShadow = '0 0 20px rgba(52, 152, 219, 0.4)';
            btn.style.transform = 'scale(0.98)';

            try {
                // A. Payment Proof (if needed) - Serial operation as it's a prerequisite
                let paymentProof = processedPaymentProof;
                if ((selectedPayment === 'vodafone' || selectedPayment === 'instapay') && !paymentProof) {
                    const fileInput = document.getElementById(selectedPayment === 'vodafone' ? 'vodafone-proof' : 'instapay-proof');
                    if (fileInput.files.length) {
                        btn.innerHTML = '<i class="fas fa-cog fa-spin"></i> جاري رفع الصورة...';
                        paymentProof = await resizeImage(fileInput.files[0], 600, 0.5);
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التنفيذ...';
                    } else {
                        showToast('الرجاء إرفاق صورة التحويل', 'error');
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.style.boxShadow = '';
                        btn.style.transform = '';
                        return;
                    }
                }

                // B. Prepare Data
                const hiddenInput = document.getElementById('province');
                const shippingCost = hiddenInput.dataset.calculatedShipping ? parseFloat(hiddenInput.dataset.calculatedShipping) : 0;
                const customerName = document.getElementById('name').value;
                const customerPhone = document.getElementById('phone').value;
                const customerAddress = document.getElementById('address').value;
                const totalAmountText = document.getElementById('checkout-total').innerText;

                // GENERATE ID UPFRONT FOR PARALLEL EXECUTION
                const orderId = 'ORD-' + Date.now();
                const orderIdShort = orderId.split('-').pop();

                const loggedInCustomer = db.getCustomer();
                const orderData = {
                    id: orderId, // Set explicitly
                    customer: {
                        name: customerName,
                        address: customerAddress,
                        province: document.getElementById('province').value,
                        phone: customerPhone,
                        email: loggedInCustomer ? loggedInCustomer.email : ''
                    },
                    items: cart,
                    subtotal: subtotal,
                    shippingCost: shippingCost,
                    discount: discount,
                    couponCode: appliedCoupon ? appliedCoupon.code : null,
                    total: Math.max(0, subtotal + shippingCost - discount),
                    paymentMethod: selectedPayment,
                    paymentProof: paymentProof,
                    packageDetails: hiddenInput.dataset.packageDetails ? JSON.parse(hiddenInput.dataset.packageDetails) : null,
                    allowInspection: document.getElementById('allow-inspection') ? document.getElementById('allow-inspection').checked : false
                };

                // C. Prepare Email Content
                const itemsRows = cart.map(i => `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${i.name} ${i.size ? '(' + i.size + ')' : ''}</td>
                        <td style="text-align: center;">${i.quantity}</td>
                        <td style="text-align: left;">${i.price} ج.م</td>
                    </tr>
                `).join('');

                const paymentName = selectedPayment === 'cod' ? 'الدفع عند الاستلام' : (selectedPayment === 'vodafone' ? 'فودافون كاش' : 'انستا باي');
                const emailMessage = `
                    <div dir="rtl" style="font-family: Arial; padding: 20px; border: 1px solid #eee; border-radius: 10px; background: #fff;">
                        <h2 style="color: #2c3e50; text-align: center; border-bottom: 2px solid #2ecc71; padding-bottom: 10px;">طلب جديد #${orderIdShort}</h2>
                        <div style="background: #fdfdfd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee;">
                            <h3 style="color: #2980b9; margin-top: 0; font-size: 16px;">👤 العميل</h3>
                            <p style="margin: 5px 0"><strong>الاسم:</strong> ${customerName}</p>
                            <p style="margin: 5px 0"><strong>الهاتف:</strong> ${customerPhone}</p>
                            <p style="margin: 5px 0"><strong>العنوان:</strong> ${customerAddress} - ${orderData.customer.province}</p>
                        </div>
                        <div style="background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                            <h3 style="color: #2980b9; margin-top: 0; font-size: 16px;">🛒 الطلب</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                                <tr style="background: #eee;">
                                    <th style="padding: 8px;">المنتج</th>
                                    <th style="padding: 8px;">الكمية</th>
                                    <th style="padding: 8px;">السعر</th>
                                </tr>
                                ${itemsRows}
                            </table>
                            <div style="background: #2c3e50; color: white; padding: 15px; text-align: center; border-radius: 5px;">
                                <div style="font-size: 1.2rem; font-weight: bold;">الإجمالي: ${totalAmountText}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">${paymentName}</div>
                            </div>
                        </div>
                    </div>
                `;

                // D. PARALLEL EXECUTION OPTIMIZATION
                // 1. Await DB Save (CRITICAL for Dashboard Reliability - Fast)
                await db.createOrder(orderData);

                localStorage.setItem('lastOrderTotal', orderData.total);
                localStorage.setItem('lastOrderId', orderId);

                // 2. Send Email Notification
                try {
                    await emailService.sendOrderNotification(orderData);
                } catch (emailErr) {
                    console.error('⚠️ Email failed (order still saved):', emailErr);
                }

                // E. CLEANUP
                if (checkoutMode === 'buynow') {
                    localStorage.removeItem('checkout_mode');
                    localStorage.removeItem('buynow_item');
                } else {
                    localStorage.removeItem('cart');
                }

                // F. REDIRECT IMMEDIATELY
                window.location.href = 'order-confirmation.html';

            } catch (err) {
                console.error('Submit Error:', err);
                showToast('حدث خطأ. يرجى المحاولة مرة أخرى.', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.background = '';
                btn.style.boxShadow = '';
                btn.style.transform = '';
            }
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> تم النسخ';
                btn.style.background = '#f0f0f0';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = 'white';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                // Fallback for some browsers
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> تم النسخ';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                    }, 2000);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);
            });
        }
    </script>
</body>

</html>